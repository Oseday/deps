<html lang="en">
    <link type="text/css" rel="stylesheet" id="dark-mode-general-link">
    <link type="text/css" rel="stylesheet" id="dark-mode-custom-link">

<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<meta name="mobile-web-app-capable" content="yes">


    <style type="text/css" id="dark-mode-custom-style"></style>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <title>VerBiPati Denetim</title>

        <!-- Bootstrap core CSS -->
        <link href="https://verbipati.org/bootstrap.min.css" rel="stylesheet">

        <meta name="theme-color" content="#563d7c">
        <script src="https://verbipati.org/jquery.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/javascript.util/0.12.12/javascript.util.min.js" type="text/javascript"></script>

        <style>
            html,
            body {
                height: 100%;
            }

            body {
                display: -ms-flexbox;
                display: flex;
                -ms-flex-align: center;
                align-items: center;
                padding-top: 40px;
                padding-bottom: 40px;
                background-color: #f5f5f5;
            }

        </style>
    </head>
    <body class="text-center" data-gr-c-s-loaded="true">
        <div class="container">
            <h2 class="text-center" id="greet">Viewer table</h2>
            <div class="row justify-content-md-center">
                <div class="col" align="center">
                    <form action="" method="GET" class="MyForm">
                        <div class="row">
                            <div class="col-12">
                                <ul class="list-group" style="max-height: 450px; overflow-y: scroll" id="myLocations">
                                </ul>
                            </div>
                            <div class="col-12">&af;</div>
                            <div class="col-12">
                                <div class="alert alert-success" id="success" role="alert">
                                    Başarılı şekilde güncellendi!
                                    <button type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                                </div>
                                <div class="alert alert-danger" id="server-error" role="alert">
                                    Sunucuda hata oluştu
                                    <button type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                                </div>
                                <div class="alert alert-warning" id="gettinglocation" role="alert">
                                    Lokasyon belirleniyor, izin istenirse lütfen izin veriniz
                                </div>
                                <div class="alert alert-danger" id="location-force-enable" role="alert">
                                    Lokasyonunuzu açın ya da ayarlarınızdan lütfen izin verin
                                    <button type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                                </div>
                                <div class="alert alert-danger" id="location-get-error" role="alert">
                                    Lokasyonunuzu alırken bir hata oluştu
                                    <button type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                                </div>
                                <button class="btn btn-lg btn-primary btn-block" type="submit">Kaydet</button>
                            </div>
                        </div>
                    </form>
                    <div>Besleme yaptığınız noktada işaretleyip orayı oradayken kaydetin böylece nerede ve ne zaman besleme yaptığınızı teyit edebilelim.</div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            window.scrollTo(0,1);

            function closeAlerts() {
                $(".alert").hide();
                $("#success").click(function() {
                    $("#success").hide();
                })
                $("#server-error").click(function() {
                    $("#server-error").hide();
                })
                $("#location-force-enable").click(function() {
                    $("#location-force-enable").hide();
                })
                $("#location-get-error").click(function() {
                    $("#location-get-error").hide();
                })
            }
            closeAlerts();

            let usernameArray = window.location.href.split("/")
            let username = usernameArray[usernameArray.length-1] //window.location.href.split("?username=")[1]
            //$("#myLocations").append(`<input type="text" name="username" value="${username}" hidden>`)

            $("#greet").html("Beslediğiniz bölgeleri seçiniz:")

            function geoLocDistance(lat1,lon1,lat2,lon2) {
                let R = 6371e3; // metres
                let p1 = lat1 * Math.PI/180; // p, l in radians
                let p2 = lat2 * Math.PI/180;
                let dp = (lat2-lat1) * Math.PI/180;
                let dl = (lon2-lon1) * Math.PI/180;

                let a = Math.sin(dp/2) * Math.sin(dp/2) +
                          Math.cos(p1) * Math.cos(p2) *
                          Math.sin(dl/2) * Math.sin(dl/2);
                let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                let d = R * c; // in metres
                return Math.floor(d+0.5);
            }

            var locationDataP;

            function GetLocText(rowData,coords) {
                let locationName = rowData[0]
                let isChecked = rowData[1]
                let isDisabled = rowData[2]
                let occupancy = rowData[3]
                let datef = rowData[4]
                let details = rowData[5]
                let distance = rowData[6]
                let loccoords = rowData[7]
                let coordstr = ""
                if (coords) {
                    let d = geoLocDistance(coords.longitude,coords.latitude,loccoords.longitude,loccoords.latitude)
                    coordstr = d>900 ? "900m" : d+"m"
                }
                let ls = ""
                if (isChecked) {
                    ls = `<d>${locationName}<i><small>  ${details}  (${occupancy}) ${datef} ${distance}</small></i></d>`
                }else{
                    ls = `<d>${locationName}<i><small>  ${details} ${coordstr}</small></i></d>`
                }

                let button = `<input type="checkbox" name="${locationName}" class="ml-auto" aria-label="Something" ${(isDisabled ? " disabled" : "")} ${(isChecked ? " checked" : "")}>`

                return ls + button
            }

            function Tracker(geoloc) {
                $(".list-group-item").each(function(index) {
                    let rowData = locationDataP[index]
                    let htmlc = GetLocText(rowData,geoloc.coords)
                    console.log(geoloc)
                    $(this).html(htmlc)
                })
            }



            function UpdateForm(data,coords){
                $("#myLocations").empty();
                locationDataP = data;
                for(let [rowId, rowData] of Object.entries(data)){
                    let locationName = rowData[0]
                    let isChecked = rowData[1]
                    let isDisabled = rowData[2]
                    let occupancy = rowData[3]
                    let datef = rowData[4]
                    let details = rowData[5]
                    let distance = rowData[6]
                    
                    let stradd = GetLocText(rowData,coords)

                    $("#myLocations").append(
                        `<li class="list-group-item d-flex align-items-center list-group-item-dark">
                            ${stradd}
                            
                        </li>`
                    )
                }
                
                $(".list-group-item").click(function(){
                    let checkbox = $(this).find("input[type=checkbox]");
                    if(!checkbox.prop("disabled")){
                        checkbox.prop("checked", !checkbox.prop("checked"))
                    }
                })

                $(".ml-auto").click(function(){
                    let checkbox = $(this).find("input[type=checkbox]");
                    if(!checkbox.prop("disabled")){
                        checkbox.prop("checked", !checkbox.prop("checked"))
                    }
                })

            }

            $.post("https://verbipati.org/viewer/tabledata", {username: username}).done(function(data) {
                UpdateForm(data)
            }).fail(function(){
                document.location.href = "index"
            })

            function submitRequest(pos){

                $("#gettinglocation").hide();

                let formData = $(".MyForm").serializeArray();

                let posttab = {
                    data: formData,
                    username: username,
                    pos: {
                        latitude: pos.coords.latitude, 
                        longitude: pos.coords.longitude
                    }
                }

                $.ajax({
                    type: "POST",
                    url: "tablesubmit",
                    data: JSON.stringify(posttab),
                    contentType: 'application/json'
                }).done(function() {
                    $("#success").show();
                }).fail(function(){
                    $("#server-error").show();
                })


                /*
                $.post("tablesubmit", stringpost).done(function() {
                    $("#success").show();
                }).fail(function(){
                    $("#server-error").show();
                })
                */
            }

            function geoError() {
                $("#gettinglocation").hide();
                $("#location-get-error").show();
            }

            let geoOptions = {
                timeout:4000,
                maximumAge:10000,
                enableHighAccuracy: true
            }

            //watchPosition disabled for now
            //navigator.geolocation.watchPosition(Tracker,geoError,geoOptions)

            function sendForm(){
                $("#location-force-enable").show();
                if (navigator.geolocation) {
                    $("#location-force-enable").hide();
                    $("#gettinglocation").show();
                    navigator.geolocation.getCurrentPosition(submitRequest,geoError,geoOptions);
                } else {
                    //submitRequest({coords:{latitude:0,longitude:0}})
                }
            }

            $(".MyForm").submit(function(event) {
                sendForm()
                event.preventDefault()
            })
        </script>
    </body>
</html>